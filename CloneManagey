local CloneManager = {}

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local CloneFolder = workspace:FindFirstChild("AI_Clone_Storage") or Instance.new("Folder", workspace)
CloneFolder.Name = "AI_Clone_Storage"

function CloneManager.Create()
    local LocalPlayer = Players.LocalPlayer
    local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local UserId = LocalPlayer.UserId

    LocalPlayer.CharacterAdded:Connect(function(c)
        Character = c
    end)

    local Clone = Players:CreateHumanoidModelFromUserId(UserId)
    Clone.Name = "Clone_" .. tick()
    Clone.Parent = CloneFolder

    local CloneRoot = Clone:WaitForChild("HumanoidRootPart")
    local Humanoid = Clone:WaitForChild("Humanoid")

    local function ApplyNoCollision()
        if not Character or not Clone.Parent then return end
        
        local cloneParts = {}
        local myParts = {}
        
        for _, p in pairs(Clone:GetDescendants()) do
            if p:IsA("BasePart") then
                table.insert(cloneParts, p)
            end
        end
        
        for _, p in pairs(Character:GetDescendants()) do
            if p:IsA("BasePart") then
                table.insert(myParts, p)
            end
        end

        for _, cp in ipairs(cloneParts) do
            if cp and cp.Parent then
                for _, mp in ipairs(myParts) do
                    if mp and mp.Parent then
                        local id = "NC_Player_" .. mp.Name
                        if not cp:FindFirstChild(id) then
                            local nc = Instance.new("NoCollisionConstraint")
                            nc.Name = id
                            nc.Part0 = cp
                            nc.Part1 = mp
                            nc.Parent = cp
                        end
                    end
                end
            end
        end

        for _, otherClone in pairs(CloneFolder:GetChildren()) do
            if otherClone ~= Clone and otherClone and otherClone.Parent then
                for _, cp in ipairs(cloneParts) do
                    if cp and cp.Parent then
                        for _, op in pairs(otherClone:GetDescendants()) do
                            if op:IsA("BasePart") and op.Parent then
                                local id = "NC_Clone_" .. otherClone.Name
                                if not cp:FindFirstChild(id) then
                                    local nc = Instance.new("NoCollisionConstraint")
                                    nc.Name = id
                                    nc.Part0 = cp
                                    nc.Part1 = op
                                    nc.Parent = cp
                                end
                            end
                        end
                    end
                end
            end
        end
    end

    local collisionLoop = RunService.Stepped:Connect(function()
        if not Clone or not Clone.Parent then return end
        ApplyNoCollision()
    end)

    task.spawn(function()
        local Torso = Clone:WaitForChild("Torso")
        local currentAnimTrack = nil
        local animNames = {
            idle = "http://www.roblox.com/asset/?id=180435571",
            walk = "http://www.roblox.com/asset/?id=180426354",
            jump = "http://www.roblox.com/asset/?id=125750702",
            fall = "http://www.roblox.com/asset/?id=180436148",
            climb = "http://www.roblox.com/asset/?id=180436334"
        }

        local function playAnimation(id)
            if currentAnimTrack and currentAnimTrack.Animation.AnimationId == id then return end
            if currentAnimTrack then currentAnimTrack:Stop() end
            local anim = Instance.new("Animation")
            anim.AnimationId = id
            currentAnimTrack = Humanoid:LoadAnimation(anim)
            currentAnimTrack:Play()
        end

        while Clone.Parent do
            local state = Humanoid:GetState()
            local velocity = CloneRoot.Velocity.Magnitude
            
            if state == Enum.HumanoidStateType.Freefall then
                playAnimation(animNames.fall)
            elseif state == Enum.HumanoidStateType.Jumping then
                playAnimation(animNames.jump)
            elseif state == Enum.HumanoidStateType.Climbing then
                playAnimation(animNames.climb)
            elseif velocity > 0.1 then
                playAnimation(animNames.walk)
            else
                playAnimation(animNames.idle)
            end

            task.wait(0.1)
        end

        collisionLoop:Disconnect()
    end)

    return Humanoid
end

return CloneManager
