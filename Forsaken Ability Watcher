local AbilityWatcher = {}

local player = game:GetService("Players").LocalPlayer
local folder = player.PlayerGui:WaitForChild("MainUI"):WaitForChild("AbilityContainer")

local selected = {}
local clicks = {}
local keywords = {}
local onFire

local function matchesKeyword(name)
	local lower = name:lower()

	for _, w in ipairs(keywords) do
		if lower:find(w) then
			return true
		end
	end

	return false
end

local function hook(btn)
	if clicks[btn] then
		return
	end

	if not btn:IsA("ImageButton") then
		return
	end

	local cd = btn:FindFirstChild("CooldownTime")
	if not cd then
		return
	end

	if matchesKeyword(btn.Name) then
		selected[btn.Name] = true
	end

	clicks[btn] = btn.MouseButton1Click:Connect(function()
		if not selected[btn.Name] then
			return
		end

		-- check cooldown
		local cd = btn:FindFirstChild("CooldownTime")
		local onCooldown = cd and cd.Text ~= ""

		if onCooldown then
			-- ignore click
			return
		end

		-- ready, fire callback
		if onFire then
			onFire(btn.Name)
		end
	end)
end

-- hook any new buttons
folder.ChildAdded:Connect(function(child)
	hook(child)
end)

-- hook existing ones
for _, child in ipairs(folder:GetChildren()) do
	hook(child)
end

function AbilityWatcher.Select(name)
	selected[name] = true
end

function AbilityWatcher.Unselect(name)
	selected[name] = nil
end

function AbilityWatcher.SelectKeyword(word)
	table.insert(keywords, word:lower())
end

function AbilityWatcher.ClearKeywords()
	table.clear(keywords)
end

function AbilityWatcher.OnFired(func)
	onFire = func
end

return AbilityWatcher
