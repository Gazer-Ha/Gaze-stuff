local lp = game.Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()
local hum = char:WaitForChild("Humanoid")
local hrp = char:WaitForChild("HumanoidRootPart")

local lastPos = hrp.Position
local customVel = Vector3.zero

game:GetService("RunService").Heartbeat:Connect(function(dt)
    local pos = hrp.Position
    customVel = (pos - lastPos) / dt
    lastPos = pos
end)

local function missing(t,f,fb)
    if type(f) == t then return f end
    return fb
end

cloneref = missing("function",cloneref,function(...) return ... end)

local Services = setmetatable({},{
    __index=function(_,name)
        return cloneref(game:GetService(name))
    end
})

local Players = Services.Players
local RunService = Services.RunService
local StarterGui = Services.StarterGui

local lp2 = Players.LocalPlayer
local c = lp2.Character or lp2.CharacterAdded:Wait()
local humanoid = c:WaitForChild("Humanoid")
local hrp0 = c:WaitForChild("HumanoidRootPart")

local lastP = hrp0.Position
local vel = Vector3.zero

RunService.Heartbeat:Connect(function(dt)
    local p = hrp0.Position
    vel = (p - lastP) / dt
    lastP = p
end)

hrp0.Archivable = true
local hrp1 = hrp0:Clone()

local joint = hrp0:FindFirstChild("RootJoint") or hrp0:FindFirstChildWhichIsA("Motor6D")
local oldPart0 = joint and joint.Part0

char.Parent = nil
hrp0.Parent = hrp1
task.wait()

if joint then
    joint.Part0 = hrp1
end

hrp1.Parent = char
char.Parent = workspace

char.PrimaryPart = hrp1

task.spawn(function()
    while hum and hum.Health do
        if hum.Health < 1 then
            if joint then joint.Part0 = oldPart0 end
            hrp0.Parent = char
            hrp1:Destroy()
            break
        end
        task.wait()
    end
end)

hrp0.Transparency = 0.5
hrp0.Shape = Enum.PartType.Ball

local maxTilt = 30
local fadeSpeed = 10
local tiltMultiplier = 1.2
local currentTiltX, currentTiltZ = 0,0
local hrp1TiltFactor = 0.4
local jumpTiltFactor = 1/2
local isR6 = humanoid.RigType == Enum.HumanoidRigType.R6

if isR6 then
    StarterGui:SetCore("SendNotification",{
        Title="FE Better? Movement 0.3",
        Text="R6 detected: no sideways anim, custom jump",
        Duration=10
    })
    coroutine.wrap(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/Gazer-Ha/NOT-MINE/refs/heads/main/R6%20animation%20custe"))()
    end)()
end

for _,tr in pairs(humanoid:GetPlayingAnimationTracks()) do tr:Stop() end

StarterGui:SetCore("SendNotification",{
    Title="FE Better? Movement 0.5",
    Text="Respawn/die To Reset Anim",
    Duration=5
})

StarterGui:SetCore("SendNotification",{
    Title="FE Better? Movement 0.5",
    Text="Added Jump Anim, Fixed Death lol",
    Duration=5
})

coroutine.wrap(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Gazer-Ha/Gaze-stuff/refs/heads/main/Fe%20Better%3F%20Shiftlock"))()
end)()

local sideTrack, backwardTrack

if not isR6 then
    local sa = Instance.new("Animation")
    sa.AnimationId = "rbxassetid://132218385473651"
    sideTrack = humanoid:LoadAnimation(sa)
    sideTrack.Priority = Enum.AnimationPriority.Movement

    local ba = Instance.new("Animation")
    ba.AnimationId = "rbxassetid://16738337225"
    backwardTrack = humanoid:LoadAnimation(ba)
    backwardTrack.Priority = Enum.AnimationPriority.Movement
end

local lastRightDot = 0
local lastTimePos = 0

local function getMoveDir()
    local d = humanoid.MoveDirection
    return d.Magnitude > 0 and d.Unit or Vector3.zero
end

RunService.Heartbeat:Connect(function(dt)
    hrp0.CanCollide = false

    local moveDir = getMoveDir()
    local speed = Vector3.new(vel.X,0,vel.Z).Magnitude
    local state = humanoid:GetState()
    local targetX,targetZ = 0,0

    if speed > 0.1 then
        local look = hrp1.CFrame.LookVector
        targetX = math.clamp(-moveDir:Dot(look)*tiltMultiplier*speed,-maxTilt,maxTilt)
        targetZ = math.clamp(-moveDir:Dot(hrp1.CFrame.RightVector)*tiltMultiplier*speed,-maxTilt,maxTilt)
    end

    if state == Enum.HumanoidStateType.Jumping or state == Enum.HumanoidStateType.Freefall then
        targetX *= jumpTiltFactor
        targetZ *= jumpTiltFactor
    end

    currentTiltX += (targetX-currentTiltX)*dt*fadeSpeed
    currentTiltZ += (targetZ-currentTiltZ)*dt*fadeSpeed

    local base = hrp1.CFrame
    local tiltA = CFrame.Angles(math.rad(currentTiltX*hrp1TiltFactor),0,math.rad(currentTiltZ*hrp1TiltFactor))
    local tiltB = CFrame.Angles(math.rad(currentTiltX),0,math.rad(currentTiltZ))

    hrp1.CFrame = base * tiltA
    hrp0.CFrame = base * tiltB
    hrp0.Velocity = Vector3.zero
    hrp0.RotVelocity = Vector3.zero
end)

local t1, t2, t3
local canPlayJump = true

if not isR6 then
    local animate = char:WaitForChild("Animate")
    animate.idle.Animation1.AnimationId = "rbxassetid://0"
    animate.idle.Animation2.AnimationId = "rbxassetid://0"
    task.wait()
    animate.idle.Animation1.AnimationId = "rbxassetid://16738333868"
    animate.idle.Animation2.AnimationId = "rbxassetid://16738334710"

    local A1 = Instance.new("Animation")
    A1.AnimationId = "rbxassetid://138665010911335"
    t1 = hum:LoadAnimation(A1)

    local A2 = Instance.new("Animation")
    A2.AnimationId = "rbxassetid://140131631438778"
    t2 = hum:LoadAnimation(A2)

    local A3 = Instance.new("Animation")
    A3.AnimationId = "rbxassetid://82261197744576"
    t3 = hum:LoadAnimation(A3)
    t3.Priority = Enum.AnimationPriority.Idle
    t3.Looped = true
end

local jumpeyAnim = Instance.new("Animation")
jumpeyAnim.AnimationId = "rbxassetid://127915306032185"
local jumpeyTrack = hum:LoadAnimation(jumpeyAnim)
jumpeyTrack.Priority = Enum.AnimationPriority.Action
jumpeyTrack.Looped = false

humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated, true)

RunService.Heartbeat:Connect(function()
    if isR6 then return end

    local moving = customVel.Magnitude > 1

    if not moving then
        if not t1.IsPlaying then t1:Play(0.1,1,1) end
        if not t2.IsPlaying then t2:Play(0.1,1,1) end

        if not t3.IsPlaying then
            t3:Play(0.1,0.06,0)
            t3.TimePosition = t3.Length * 0.98
        end
    else
        if t1.IsPlaying then t1:Stop(0.1) end
        if t2.IsPlaying then t2:Stop(0.1) end
        if t3.IsPlaying then t3:Stop(0.1) end
    end
end)

RunService.PreSimulation:Connect(function()
    if isR6 then return end

    local state = humanoid:GetState()
    local moveDir = humanoid.MoveDirection
    local actual = Vector3.new(vel.X,0,vel.Z).Magnitude

    local forwardDot = moveDir:Dot(hrp1.CFrame.LookVector)
    local rightDot = moveDir:Dot(hrp1.CFrame.RightVector)

    if state == Enum.HumanoidStateType.Jumping or state == Enum.HumanoidStateType.Freefall then
        if sideTrack.IsPlaying then sideTrack:Stop(0.1) end
        if backwardTrack.IsPlaying then backwardTrack:Stop(0.1) end
        if canPlayJump and not jumpeyTrack.IsPlaying then
            jumpeyTrack:Play(0.1)
            canPlayJump = false
        end
        lastRightDot = rightDot
        return
    end

    if state == Enum.HumanoidStateType.Landed then
        if jumpeyTrack.IsPlaying then jumpeyTrack:Stop(0.1) end
        canPlayJump = true
        return
    end

    if math.abs(rightDot) > math.abs(forwardDot) then
        if not sideTrack.IsPlaying then
            sideTrack:Play(0.1)
            sideTrack.TimePosition = lastTimePos
        end
        local alpha = actual / 16
        sideTrack:AdjustWeight(math.clamp(0.5 + 0.5 * alpha,0,1))
        sideTrack:AdjustSpeed(1.5 * alpha * (rightDot >= 0 and -1 or 1))
        if (rightDot > 0 and lastRightDot < 0) or (rightDot < 0 and lastRightDot > 0) then
            sideTrack.TimePosition = lastTimePos
        end
    else
        if sideTrack.IsPlaying then sideTrack:Stop(0.1) end
    end

    if forwardDot <= -0.5 then
        if not backwardTrack.IsPlaying then backwardTrack:Play() end
        local alpha = actual / 16
        backwardTrack:AdjustWeight(math.clamp(alpha,0,1))
        backwardTrack:AdjustSpeed(-1.3 * alpha)
    else
        if backwardTrack.IsPlaying then backwardTrack:Stop(0.1) end
    end

    lastRightDot = rightDot
end)

print("hey FE Better? Movement patched")
