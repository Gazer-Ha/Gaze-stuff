local CloneManager = {}

local Players = game:GetService("Players")

local CloneFolder = workspace:FindFirstChild("AI_Clone_Storage") or Instance.new("Folder", workspace)
CloneFolder.Name = "AI_Clone_Storage"

function CloneManager.Create()
    local LocalPlayer = Players.LocalPlayer
    local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local UserId = LocalPlayer.UserId

    LocalPlayer.CharacterAdded:Connect(function(c)
        Character = c
    end)

    local Clone = Players:CreateHumanoidModelFromUserId(UserId)
    Clone.Name = "Clone_" .. tick()
    Clone.Parent = CloneFolder

    local CloneRoot = Clone:WaitForChild("HumanoidRootPart")
    local Humanoid = Clone:WaitForChild("Humanoid")

    local cache = {}

    local function pair(p0, p1, t)
        if not (p0 and p1 and p0.Parent and p1.Parent) then return end
        local key = p0:GetDebugId() .. "_" .. p1:GetDebugId() .. "_" .. t
        if cache[key] then return end
        local nc = Instance.new("NoCollisionConstraint")
        nc.Name = key
        nc.Part0 = p0
        nc.Part1 = p1
        nc.Parent = p0
        cache[key] = nc
    end

    local function syncCloneWithCharacter(part)
        if not part:IsA("BasePart") then return end
        for _, mp in pairs(Character:GetDescendants()) do
            if mp:IsA("BasePart") then
                pair(part, mp, "P")
            end
        end
        for _, otherClone in pairs(CloneFolder:GetChildren()) do
            if otherClone ~= Clone then
                for _, op in pairs(otherClone:GetDescendants()) do
                    if op:IsA("BasePart") then
                        pair(part, op, "C")
                    end
                end
            end
        end
    end

    local function syncCharacterWithClone(part)
        if not part:IsA("BasePart") then return end
        for _, cp in pairs(Clone:GetDescendants()) do
            if cp:IsA("BasePart") then
                pair(cp, part, "P")
            end
        end
    end

    for _, p in pairs(Clone:GetDescendants()) do
        syncCloneWithCharacter(p)
    end

    for _, p in pairs(Character:GetDescendants()) do
        syncCharacterWithClone(p)
    end

    Clone.DescendantAdded:Connect(syncCloneWithCharacter)
    Character.DescendantAdded:Connect(syncCharacterWithClone)

    CloneFolder.ChildAdded:Connect(function(otherClone)
        if otherClone == Clone then return end
        for _, cp in pairs(Clone:GetDescendants()) do
            if cp:IsA("BasePart") then
                for _, op in pairs(otherClone:GetDescendants()) do
                    if op:IsA("BasePart") then
                        pair(cp, op, "C")
                    end
                end
            end
        end
    end)

    task.spawn(function()
        local Torso = Clone:WaitForChild("Torso")
        local currentAnimTrack
        local animNames = {
            idle = "http://www.roblox.com/asset/?id=180435571",
            walk = "http://www.roblox.com/asset/?id=180426354",
            jump = "http://www.roblox.com/asset/?id=125750702",
            fall = "http://www.roblox.com/asset/?id=180436148",
            climb = "http://www.roblox.com/asset/?id=180436334"
        }

        local function playAnimation(id)
            if currentAnimTrack and currentAnimTrack.Animation.AnimationId == id then return end
            if currentAnimTrack then currentAnimTrack:Stop() end
            local anim = Instance.new("Animation")
            anim.AnimationId = id
            currentAnimTrack = Humanoid:LoadAnimation(anim)
            currentAnimTrack:Play()
        end

        while Clone.Parent do
            local state = Humanoid:GetState()
            local velocity = CloneRoot.Velocity.Magnitude

            if state == Enum.HumanoidStateType.Freefall then
                playAnimation(animNames.fall)
            elseif state == Enum.HumanoidStateType.Jumping then
                playAnimation(animNames.jump)
            elseif state == Enum.HumanoidStateType.Climbing then
                playAnimation(animNames.climb)
            elseif velocity > 0.1 then
                playAnimation(animNames.walk)
            else
                playAnimation(animNames.idle)
            end

            task.wait(0.1)
        end
    end)

    return Humanoid
end

return CloneManager
